<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Movie Line Looper</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input[type="number"], input[type="file"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.primary {
      background: #4f8ef7;
      color: #fff;
    }
    button.primary:hover {
      background: #3a79d6;
    }
    button.danger {
      background: #f14545;
      color: #fff;
    }
    button.danger:hover {
      background: #d83232;
    }
    video, audio {
      width: 100%;
      max-height: 360px;
      margin-top: 1rem;
    }
    .time-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .time-controls input[type="number"] {
      flex: 1;
    }
    .status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Movie Line Looper</h1>
    <p>Load a local video/audio file, set the start &amp; end time of the line you want, then press "Start Loop" to hear the original sound repeatedly.</p>

    <label for="file-input">Select movie/audio file</label>
    <input id="file-input" type="file" accept="video/*,audio/*" />

    <!-- Hidden until a file is chosen -->
    <div id="player-wrapper" style="display:none">
      <video id="media" controls></video>
      <!-- If audio file, we'll swap to <audio> element dynamically -->

      <label>Choose segment (seconds)</label>
      <div class="time-controls">
        <input id="start-time" type="number" min="0" step="0.01" placeholder="Start" />
        <button id="set-start" type="button">Set ← current</button>
        <input id="end-time" type="number" min="0" step="0.01" placeholder="End" />
        <button id="set-end" type="button">Set ← current</button>
      </div>

      <button id="loop-btn" class="primary">Start Loop</button>
      <button id="stop-loop-btn" class="danger" disabled>Stop Loop</button>
      <div class="status" id="status">Ready</div>
    </div>
  </div>

  <script>
    (function() {
      const fileInput = document.getElementById('file-input');
      const playerWrapper = document.getElementById('player-wrapper');
      const videoEl = document.getElementById('media');
      const startInput = document.getElementById('start-time');
      const endInput = document.getElementById('end-time');
      const setStartBtn = document.getElementById('set-start');
      const setEndBtn = document.getElementById('set-end');
      const loopBtn = document.getElementById('loop-btn');
      const stopLoopBtn = document.getElementById('stop-loop-btn');
      const statusEl = document.getElementById('status');

      let loopActive = false;
      let startTime = 0;
      let endTime = 0;
      let repeatCount = 0; // unlimited by default

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);

        // Swap media element if file is audio
        if (file.type.startsWith('audio')) {
          const audio = document.createElement('audio');
          audio.id = 'media';
          audio.controls = true;
          playerWrapper.replaceChild(audio, videoEl);
          mediaEl = audio;
        } else {
          // if video
          mediaEl = videoEl;
        }

        mediaEl.src = url;
        playerWrapper.style.display = 'block';
        statusEl.textContent = 'Loaded. Choose segment.';
      });

      let mediaEl = videoEl;

      function validateTimes() {
        startTime = parseFloat(startInput.value);
        endTime = parseFloat(endInput.value);
        if (Number.isNaN(startTime) || Number.isNaN(endTime) || endTime <= startTime) {
          alert('Please enter valid start and end times (end must be greater than start).');
          return false;
        }
        if (startTime < 0 || endTime > mediaEl.duration) {
          alert('Start or end time is out of range of the media duration.');
          return false;
        }
        return true;
      }

      setStartBtn.addEventListener('click', () => {
        startInput.value = mediaEl.currentTime.toFixed(2);
      });

      setEndBtn.addEventListener('click', () => {
        endInput.value = mediaEl.currentTime.toFixed(2);
      });

      loopBtn.addEventListener('click', () => {
        if (!validateTimes()) return;
        loopActive = true;
        loopBtn.disabled = true;
        stopLoopBtn.disabled = false;
        statusEl.textContent = `Looping from ${startTime.toFixed(2)}s to ${endTime.toFixed(2)}s...`;
        mediaEl.currentTime = startTime;
        mediaEl.play();
      });

      stopLoopBtn.addEventListener('click', stopLoop);

      function stopLoop() {
        loopActive = false;
        loopBtn.disabled = false;
        stopLoopBtn.disabled = true;
        statusEl.textContent = 'Stopped looping';
      }

      mediaEl.addEventListener('timeupdate', () => {
        if (loopActive && mediaEl.currentTime >= endTime) {
          mediaEl.currentTime = startTime;
          mediaEl.play();
        }
      });

      mediaEl.addEventListener('ended', () => {
        // In case media ends before reaching endTime
        if (loopActive) {
          mediaEl.currentTime = startTime;
          mediaEl.play();
        }
      });
    })();
  </script>
</body>
</html>